# DOCX Parser Web App

Веб-приложение для проверки форматирования документов DOCX и добавления комментариев к нарушениям форматирования. Прототип вдохновлён LLM. Дебаггинг и точная реализация методов описана вручную.

Доступна задеплоенная версия: https://trelawney.pythonanywhere.com

## Описание

DocxNormControl Web - это веб-версия приложения для проверки документов .docx на соответствие требованиям форматирования. Приложение анализирует загруженный документ и создаёт его копию с комментариями для всех найденных нарушений правил форматирования.

### Основные возможности

- Загрузка файлов .docx через веб-интерфейс
- Проверка полей страницы, шрифта, отступов, выравнивания и других аспектов форматирования
- Генерация комментариев для каждого найденного нарушения
- Возможность скачать обработанный документ с комментариями

## Требования

- Python 3.13+
- python-docx 1.2.0+
- Flask 3.0+

## Установка

1. Установите Python 3.13+ с [официального сайта](https://www.python.org/downloads/)
2. Установите зависимости:
   ```
   py -3.13 -m pip install python-docx flask
   ```

## Запуск приложения

```
run_app.bat
```

или

```
py -3.13 -m flask run
```

## Последние улучшения

### 1. Решение проблемы "съезжания" комментариев

В версии 0.5 приложения была обнаружена проблема "съезжания" комментариев: комментарии добавлялись не к тем абзацам, к которым должны были.

Проблема была решена путем использования официального API для комментариев, доступного в python-docx 1.2.0+. Новая реализация функции `add_comments_to_docx` в файле `comment_utils.py` напрямую использует метод `Document.add_comment()`, который корректно привязывает комментарии к соответствующим элементам текста.

### 2. Улучшение определения параметров форматирования при использовании стилей

В версии 0.5 приложения обнаружена проблема некорректного определения параметров форматирования (отступов, выравнивания и т.д.) при использовании стилей Word. Код проверял только прямое форматирование и не учитывал параметры, унаследованные от стилей, что приводило к ложным срабатываниям.

Решение:
1. Создан новый модуль `formatting_utils.py` с функциями для определения эффективных параметров форматирования с учетом стилей
2. Обновлены функции проверки в `formatting_checker.py` для использования новых функций определения форматирования
3. Добавлены тесты для проверки определения параметров форматирования

Эти улучшения позволяют корректно проверять документы, созданные с использованием стилей Word, и избежать ложных срабатываний при проверке форматирования.

## Подробности реализации

### Решение проблемы "съезжания" комментариев

1. Получаем объект параграфа по индексу из списка параграфов документа
2. Получаем "runs" (фрагменты текста) внутри параграфа
3. Добавляем комментарий к этим "runs" с помощью метода `doc.add_comment()`
4. Если в параграфе нет "runs", создаем новый "run" и добавляем комментарий к нему

### Решение проблемы определения форматирования при использовании стилей

1. Создан набор функций для определения эффективных параметров форматирования:
   - `get_effective_first_line_indent` - определяет отступ первой строки с учетом стилей
   - `get_effective_alignment` - определяет выравнивание с учетом стилей
   - `get_effective_line_spacing` - определяет межстрочный интервал с учетом стилей
   - `get_effective_space_after` - определяет интервал после абзаца с учетом стилей

2. Функции проверяют параметры в следующем порядке:
   - Прямое форматирование параграфа (имеет приоритет)
   - Параметры в стиле параграфа
   - Параметры в базовом стиле параграфа (родительский стиль)

3. Модифицированы функции проверки, чтобы они использовали эти новые функции, обеспечивая корректное определение форматирования.

## Известные ограничения

1. Необходим Python 3.13+ и python-docx 1.2.0+
2. Индексы параграфов должны быть корректными (в пределах количества параграфов в документе)
3. Для добавления комментариев к тексту в таблицах требуется дополнительная доработка
4. Возможны ложные идентификации элементов в случае использование пользовательских стилей. Оптимально не использовать стили или использовать базовые (встроенные в Word) стили.

## Тестирование

Для тестирования определения параметров форматирования используйте:
```
py -3.13 test_style_detection.py путь_к_файлу.docx
```

## Структура проекта

```
docx-norm-control-web/
│
├── app.py                      # Основной файл приложения Flask
├── static/                     # Статические файлы
│   ├── css/
│   │   └── styles.css          # Стили для веб-интерфейса
│   ├── js/
│   │   └── main.js             # JavaScript для интерактивности
│   └── img/
│       └── success.svg         # Иконка успешной проверки
│
├── templates/                  # HTML-шаблоны
│   ├── index.html              # Главная страница с формой загрузки
│   └── result.html             # Страница с результатами проверки
│
├── uploads/                    # Директория для загружаемых файлов
│
├── formatting_checker.py       # Модуль проверки форматирования
├── comment_utils.py            # Модуль для работы с комментариями
│
├── requirements.txt            # Зависимости проекта
└── README.md                   # Документация
```

## Правила проверки форматирования

Приложение проверяет следующие аспекты форматирования:

- Поля страницы (верхнее, нижнее, левое, правое)
- Шрифт, цвет и размер шрифта основного текста (Times New Roman, 14pt)
- Межстрочный интервал (1.5)
- Отступ первой строки (1.25 см)
- Выравнивание текста (по ширине)
- Форматирование заголовков первого уровня и второго уровня (разделы, подразделы)
- Форматирование структурных заголовков (СОДЕРЖАНИЕ, ВВЕДЕНИЕ, ЗАКЛЮЧЕНИЕ и т.д.)
- Форматирование таблиц и подписей к ним
- Форматирование рисунков и подписей к ним

## Примечания по безопасности

- Загруженные файлы временно сохраняются на сервере
- Система автоматически удаляет файлы старше 24 часов
